@model List<_13_State_Management.Models.CartItem>
@{
    ViewData["Title"] = "Sepetim";
    decimal totalPrice = Model?.Sum(x => x.Price * x.Quantity) ?? 0;
    int totalItems = Model?.Sum(x => x.Quantity) ?? 0;
}

<div class="container mt-4">
    <!-- 🎯 Başlık -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-shopping-cart text-primary"></i> Sepetim</h2>
                <div class="badge bg-primary fs-6">@totalItems Ürün</div>
            </div>
            <hr>
        </div>
    </div>

    @if (Model == null || !Model.Any())
    {
        <!-- 🛒 Boş Sepet -->
        <div class="row justify-content-center">
            <div class="col-md-6 text-center">
                <div class="card shadow-sm">
                    <div class="card-body py-5">
                        <i class="fas fa-shopping-cart fa-5x text-muted mb-3"></i>
                        <h4 class="text-muted">Sepetiniz Boş</h4>
                        <p class="text-muted">Alışverişe başlamak için ürün ekleyin.</p>
                        <a asp-controller="Home" asp-action="Index" class="btn btn-primary">
                            <i class="fas fa-arrow-left"></i> Alışverişe Devam Et
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- 📋 Sepet İçeriği -->
        <div class="row">
            <!-- 🛍️ Ürün Listesi -->
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-list"></i> Sepet İçeriği</h5>
                    </div>
                    <div class="card-body p-0">
                        @foreach (var item in Model)
                        {
                            <div class="border-bottom p-3" id="cart-item-@item.ProductId">
                                <div class="row align-items-center">
                                    <!-- 📸 Ürün Resmi (Placeholder) -->
                                    <div class="col-md-2">
                                        <div class="bg-light rounded d-flex align-items-center justify-content-center"
                                             style="height: 80px;">
                                            <i class="fas fa-box fa-2x text-muted"></i>
                                        </div>
                                    </div>

                                    <!-- ℹ️ Ürün Bilgileri -->
                                    <div class="col-md-4">
                                        <h6 class="mb-1 fw-bold">@item.ProductName</h6>
                                        <small class="text-muted">ID: @item.ProductId</small>
                                    </div>

                                    <!-- 🔢 Miktar Kontrolü -->
                                    <div class="col-md-3">
                                        <div class="input-group input-group-sm">
                                            <button class="btn btn-outline-secondary" type="button"
                                                    onclick="updateQuantity(@item.ProductId, -1)">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input type="number" class="form-control text-center"
                                                   value="@item.Quantity" min="1"
                                                   id="quantity-@item.ProductId"
                                                   onchange="updateQuantityDirect(@item.ProductId, this.value)">
                                            <button class="btn btn-outline-secondary" type="button"
                                                    onclick="updateQuantity(@item.ProductId, 1)">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- 💰 Fiyat -->
                                    <div class="col-md-2 text-end">
                                        <div class="fw-bold text-primary">
                                            ₺@((item.Price * item.Quantity).ToString("N2"))
                                        </div>
                                        <small class="text-muted">
                                            ₺@item.Price.ToString("N2") x @item.Quantity
                                        </small>
                                    </div>

                                    <!-- 🗑️ Silme Butonu -->
                                    <div class="col-md-1 text-end">
                                        <button class="btn btn-outline-danger btn-sm"
                                                onclick="removeItem(@item.ProductId)"
                                                title="Sepetten Çıkar">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- 🔄 Sepet İşlemleri -->
                <div class="mt-3">
                    <div class="d-flex gap-2">
                        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left"></i> Alışverişe Devam
                        </a>
                        <button class="btn btn-outline-warning" onclick="clearCart()">
                            <i class="fas fa-trash-alt"></i> Sepeti Temizle
                        </button>
                    </div>
                </div>
            </div>

            <!-- 💳 Sipariş Özeti -->
            <div class="col-lg-4">
                <div class="card shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-calculator"></i> Sipariş Özeti</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Toplam Ürün:</span>
                            <span class="fw-bold">@totalItems adet</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Ara Toplam:</span>
                            <span>₺@totalPrice.ToString("N2")</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Kargo:</span>
                            <span class="text-success">Ücretsiz</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <span class="fw-bold fs-5">Toplam:</span>
                            <span class="fw-bold fs-5 text-primary">₺@totalPrice.ToString("N2")</span>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-lg" onclick="checkout()">
                                <i class="fas fa-credit-card"></i> Siparişi Tamamla
                            </button>
                            <button class="btn btn-outline-info" onclick="saveForLater()">
                                <i class="fas fa-bookmark"></i> Daha Sonra İçin Kaydet
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- 🔄 Loading Spinner -->
<div id="loading-spinner" class="d-none">
    <div class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex align-items-center justify-content-center" style="z-index: 9999;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Yükleniyor...</span>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // 🚀 PERFORMANS İYİLEŞTİRMESİ: Debounce fonksiyonu
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 🔄 Miktar Güncelleme (Optimized)
        const updateQuantityDebounced = debounce(function(itemId, change) {
            const quantityInput = document.getElementById(`quantity-${itemId}`);
            let newQuantity = parseInt(quantityInput.value) + change;

            if (newQuantity < 1) {
                if (confirm('Bu ürünü sepetten çıkarmak istiyor musunuz?')) {
                    removeItem(itemId);
                    return;
                }
                newQuantity = 1;
            }

            quantityInput.value = newQuantity;
            updateCartItem(itemId, newQuantity);
        }, 300);

        function updateQuantity(itemId, change) {
            updateQuantityDebounced(itemId, change);
        }

        // 🎯 Direkt Miktar Güncelleme
        const updateQuantityDirectDebounced = debounce(function(itemId, quantity) {
            const qty = parseInt(quantity);
            if (qty < 1) {
                document.getElementById(`quantity-${itemId}`).value = 1;
                return;
            }
            updateCartItem(itemId, qty);
        }, 500);

        function updateQuantityDirect(itemId, quantity) {
            updateQuantityDirectDebounced(itemId, quantity);
        }

        // 🔄 AJAX ile Sepet Güncelleme (Performans Optimized)
        function updateCartItem(itemId, quantity) {
            showLoading(true);

            fetch('@Url.Action("UpdateQuantity", "ShoppingCart")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                body: JSON.stringify({ itemId: itemId, quantity: quantity })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Sadece değişen kısmı güncelle (DOM manipulation minimize)
                    updateCartDisplay(data);
                    showToast('Sepet güncellendi', 'success');
                } else {
                    showToast('Hata: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Bir hata oluştu', 'error');
            })
            .finally(() => {
                showLoading(false);
            });
        }

        // 🗑️ Ürün Silme
        function removeItem(itemId) {
            if (!confirm('Bu ürünü sepetten çıkarmak istediğinizden emin misiniz?')) {
                return;
            }

            showLoading(true);

            fetch('@Url.Action("RemoveFromCart", "ShoppingCart")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ itemId: itemId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Smooth removal animation
                    const itemElement = document.getElementById(`cart-item-${itemId}`);
                    itemElement.style.transition = 'opacity 0.3s ease';
                    itemElement.style.opacity = '0';

                    setTimeout(() => {
                        location.reload(); // Sayfayı yenile
                    }, 300);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Silme işlemi başarısız', 'error');
            })
            .finally(() => {
                showLoading(false);
            });
        }

        // 🧹 Sepeti Temizle
        function clearCart() {
            if (!confirm('Sepetteki tüm ürünleri silmek istediğinizden emin misiniz?')) {
                return;
            }

            showLoading(true);

            fetch('@Url.Action("ClearCart", "ShoppingCart")', {
                method: 'POST'
            })
            .then(() => {
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Temizleme işlemi başarısız', 'error');
            });
        }

        // 💳 Checkout
        function checkout() {
            showLoading(true);
            // Checkout sayfasına yönlendir
            window.location.href = '@Url.Action("Checkout", "ShoppingCart")';
        }

        // 💾 Daha Sonra İçin Kaydet
        function saveForLater() {
            showToast('Sepet kaydedildi', 'info');
        }

        // 🔄 Loading Gösterge
        function showLoading(show) {
            const spinner = document.getElementById('loading-spinner');
            if (show) {
                spinner.classList.remove('d-none');
            } else {
                spinner.classList.add('d-none');
            }
        }

        // 🎯 Toast Bildirimleri
        function showToast(message, type) {
            // Bootstrap toast veya basit alert
            const alertClass = type === 'success' ? 'alert-success' :
                              type === 'error' ? 'alert-danger' : 'alert-info';

            const toast = `
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed"
                     style="top: 20px; right: 20px; z-index: 9999;" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', toast);

            // 3 saniye sonra otomatik kapat
            setTimeout(() => {
                const alerts = document.querySelectorAll('.alert');
                alerts[alerts.length - 1]?.remove();
            }, 3000);
        }

        // 📊 Sayfa Yüklenme Performansı
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Sepet sayfası yüklendi');

            // Lazy loading için intersection observer
            const images = document.querySelectorAll('img[data-src]');
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                        imageObserver.unobserve(img);
                    }
                });
            });

            images.forEach(img => imageObserver.observe(img));
        });
    </script>
}
